---
platform: linux
inputs:
- name: metrics
- name: helm-repo
- name: image-tag
outputs:
- name: helm-chart
image_resource:
  type: docker-image
  source:
   repository: splatform/ci-stratos-helm
   tag: "latest"

run:
  path: bash
  args:
    - -xc
    - |

      helm init --client-only
      ROOT_DIR=$PWD
      STRATOS_METRICS=${ROOT_DIR}/metrics
      IMAGE_TAG_DIR=${ROOT_DIR}/image-tag
      HELM_REPO=${ROOT_DIR}/helm-repo
      TAG=$(cat ${IMAGE_TAG_DIR}/release-tag)
      COMMIT=$(cat ${IMAGE_TAG_DIR}/commit)
      RELEASE_VERSION=$(cat ${IMAGE_TAG_DIR}/tag)
      GIT_TAG=$(cat ${IMAGE_TAG_DIR}/tag)

      if [ ! -z "${GIT_TAG_SUFFIX}" ]; then
        GIT_TAG="${GIT_TAG}-${GIT_TAG_SUFFIX}"
      fi

      set +x
      echo "Tag             : $GIT_TAG"
      echo "Commit          : $COMMIT"
      echo "Release Version : $RELEASE_VERSION"
      set -x

      # Helper
      source ${STRATOS_METRICS}/build/ci/tasks/create-chart-helper.sh

      cd ${STRATOS_METRICS}
      CHART_PATH=${STRATOS_METRICS}
      echo "$CHART_PATH"
      
      VERSION=$(cat Chart.yaml | grep version | cut -d' ' -f2 | tr -d '\n')
      echo "${VERSION}"

      # Patch Helm chart
      sed -i -e 's/imageTag: opensuse/imageTag: '"${TAG}"'/g' ${CHART_PATH}/values.yaml
      sed -i -e 's/tag: opensuse/tag: '"${TAG}"'/g' ${CHART_PATH}/values.yaml
      sed -i -e 's@repository: splatform@repository: '"${DOCKER_REGISTRY}"'/'"${DOCKER_ORG}"'@g' ${CHART_PATH}/values.yaml
      sed -i -e 's/dockerOrganization: splatform/dockerOrganization: '"${DOCKER_ORG}"'/g' ${CHART_PATH}/values.yaml
      sed -i -e 's/dockerRepository: docker.io/dockerRepository: '"${DOCKER_REGISTRY}"'/g' ${CHART_PATH}/values.yaml
      sed -i -e 's/version: 0.1.0/version: '"${TAG}"'/g' ${CHART_PATH}/Chart.yaml  

      # Required for setupAndPushChange commit message
      IMAGE_TAG=${GIT_TAG}
      patchHelmChart ${GIT_TAG} ${DOCKER_ORG} ${DOCKER_REGISTRY} . ${RELEASE_VERSION} ${VERSION}

      CHART_FILENAME="metrics-helm-chart-${RELEASE_VERSION}-${COMMIT}.tgz"
      if [ ! -z "${CHART_SUFFIX}" ]; then
        CHART_FILENAME="metrics-helm-chart-${RELEASE_VERSION}-${COMMIT}-${CHART_SUFFIX}.tgz"
      fi

      # Generate Helm package
      updateHelmDependency
      helm package ./
      mv metrics-*.tgz ${ROOT_DIR}/helm-chart/${CHART_FILENAME}
      cd ${ROOT_DIR}/helm-chart/
      if [ -f ${HELM_REPO}/index.yaml ]; then
        cp ${HELM_REPO}/index.yaml ${ROOT_DIR}/helm-chart/
        MERGE_INDEX="--merge index.yaml"
      fi
      
      # Update Helm Repository
      helm repo index ./ ${MERGE_INDEX} --url https://github.com/${GITHUB_ORG}/${GITHUB_REPO}/releases/download/${RELEASE_VERSION}/
      cp index.yaml ${HELM_REPO}
      cd ${HELM_REPO}
      setupAndPushChange
