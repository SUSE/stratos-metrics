---
platform: linux
inputs:
- name: metrics
outputs:
- name: image-tag
image_resource:
  type: docker-image
  source:
   repository:  splatform/ci-stratos-concourse
   tag: "latest"

run:
  path: bash
  args:
  - -exc
  - |

    cd metrics
    COMMIT=$(git log -1 --format="%h")
    VERSION=$(cat Chart.yaml | grep version| cut -d' ' -f2 | tr -d '\n')

    TAG=$VERSION-${COMMIT}
    if [ ! -z ${TAG_SUFFIX} ]; then
      if [ "${TAG_SUFFIX}" != "null" ]; then
          TAG=${TAG}-${TAG_SUFFIX}
      fi
    fi

    echo $TAG > release-tag
    tar -cf release-tag-${COMMIT}.tar release-tag

    mv *.tar ../image-tag/