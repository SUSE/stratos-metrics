---
platform: linux
inputs:
- name: metrics
- name: image-tag
image_resource:
  type: docker-image
  source:
   # Generated using scripts/Dockerfile.stratos-ci
   repository: splatform/stratos-ci-concourse
   tag: "latest"

run:
  path: sh
  args:
    - -exc
    - |
      # Check that the Github release DOES NOT exist
      ROOT_DIR=${PWD}
      VERSION=$(cat image-tag/version)
      FULL_VERSION=$(cat image-tag/release-tag) 
      GIT_TAG=$(cat image-tag/tag) 
      METRICS=${ROOT_DIR}/metrics
      source ${METRICS}/build/ci/tasks/github-helper.sh

      # Check tagged release version is consistent with package.json version
      TAG_RELEASE_VERSION=$(echo ${FULL_VERSION} | cut -d"-" -f1)
      if [ "${TAG_RELEASE_VERSION}" != "${VERSION}" ]; then
        echo "Chart version is not consistent with tag release version! ${TAG_RELEASE_VERSION} != ${VERSION}"
        exit 1
      fi
      cd ${ROOT_DIR}/metrics

      # Check that the release exists
      set +e
      github-release info -t ${GIT_TAG}
      RETVAL=$?
      set -e

      if [ $RETVAL -eq 0 ]; then
        echo "Aborting... release already exists"
        exit 1
      fi

      echo "Release does not exist.. OK"